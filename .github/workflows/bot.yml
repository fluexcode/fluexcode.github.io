name: ðŸš€ Deploy FluexCode Bot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v3
      
    # 2. Setup Node.js
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    # 3. Initialize npm and install dependencies
    - name: ðŸ“¦ Initialize and install dependencies
      run: |
        # package.json yoksa oluÅŸtur
        if [ ! -f "package.json" ]; then
          echo "Creating package.json..."
          cat > package.json << EOF
          {
            "name": "fluexcode-bot",
            "version": "1.0.0",
            "description": "FluexCode Twitch Bot",
            "main": "server.js",
            "scripts": {
              "start": "node server.js",
              "bot": "node bot.js"
            },
            "dependencies": {
              "tmi.js": "^1.8.5",
              "express": "^4.18.2",
              "axios": "^1.3.4",
              "dotenv": "^16.0.3",
              "cors": "^2.8.5",
              "express-session": "^1.17.3"
            }
          }
          EOF
        fi
        
        # Dependencies'i yÃ¼kle
        npm install
        
        # package-lock.json kontrolÃ¼
        if [ -f "package-lock.json" ]; then
          echo "âœ… package-lock.json created"
        else
          echo "âš ï¸ package-lock.json not created, using npm ci instead"
        fi
      
    # 4. Create .env file
    - name: ðŸ”§ Create environment file
      run: |
        echo "BOT_USERNAME=${{ secrets.BOT_USERNAME }}" > .env
        echo "BOT_OAUTH=${{ secrets.BOT_OAUTH }}" >> .env
        echo "BOT_CLIENT_ID=${{ secrets.BOT_CLIENT_ID }}" >> .env
        echo "BOT_CLIENT_SECRET=${{ secrets.BOT_CLIENT_SECRET }}" >> .env
        echo "DEFAULT_CHANNEL=${{ secrets.DEFAULT_CHANNEL || 'fluexcode' }}" >> .env
        echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD || 'fluexcode123' }}" >> .env
        echo "SESSION_SECRET=${{ secrets.SESSION_SECRET || 'fluexcode-secret' }}" >> .env
        echo "PORT=3000" >> .env
        
    # 5. Create data directory
    - name: ðŸ“ Create data directory
      run: |
        mkdir -p data
        echo "${{ secrets.DEFAULT_CHANNEL || 'fluexcode' }}" > data/current_channel.txt
        
    # 6. Check files
    - name: ðŸ§ª Check file structure
      run: |
        echo "ðŸ“ Current files:"
        ls -la
        
        echo ""
        echo "ðŸ“„ Checking bot.js..."
        if [ -f "bot.js" ]; then
          echo "âœ… bot.js exists"
          echo "First 3 lines:"
          head -3 bot.js
        else
          echo "âŒ bot.js missing!"
          exit 1
        fi
        
        echo ""
        echo "ðŸ“„ Checking server.js..."
        if [ -f "server.js" ]; then
          echo "âœ… server.js exists"
        else
          echo "âŒ server.js missing!"
          exit 1
        fi
        
    # 7. Start the bot
    - name: ðŸš€ Start FluexCode Bot
      run: |
        echo "ðŸ¤– Starting FluexCode Bot..."
        echo "ðŸ“º Channel: $(cat data/current_channel.txt)"
        
        # Bot'u baÅŸlat
        node bot.js &
        BOT_PID=$!
        
        # Server'Ä± baÅŸlat
        node server.js &
        SERVER_PID=$!
        
        echo "â³ Waiting 20 seconds..."
        sleep 20
        
        # Kontrol
        if ps -p $BOT_PID > /dev/null && ps -p $SERVER_PID > /dev/null; then
          echo "âœ… Bot and Server are running!"
          echo "ðŸ¤– Bot PID: $BOT_PID"
          echo "ðŸŒ Server PID: $SERVER_PID"
        else
          echo "âŒ Failed to start"
          exit 1
        fi
        
    # 8. Keep alive
    - name: ðŸ”„ Keep bot alive
      run: |
        echo "ðŸ”„ Bot will run for 6 hours (GitHub limit)..."
        
        # 6 saat boyunca Ã§alÄ±ÅŸ
        for i in {1..360}; do
          sleep 60
          echo "â° Minute $i: Bot is running on channel $(cat data/current_channel.txt 2>/dev/null || echo 'unknown')"
        done
        
        echo "ðŸ”„ Time limit reached, workflow will restart"
